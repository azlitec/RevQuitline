generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Report {
  id          String   @id @default(cuid())
  title       String
  type        String
  period      String
  generatedAt DateTime @default(now())
  fileUrl     String?
  status      String   @default("generating")
  data        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([period])
  @@index([status])
  @@index([createdAt])
}

model User {
  id                            String                    @id @default(cuid())
  firstName                     String?
  lastName                      String?
  email                         String                    @unique
  password                      String
  image                         String?
  bio                           String?
  dateOfBirth                   DateTime?
  gender                        String?
  phone                         String?
  address                       String?
  emergencyContact              String?
  emergencyPhone                String?
  medicalHistory                String?
  currentMedications            String?
  allergies                     String?
  smokingStatus                 String?                   @default("unknown")
  smokingHistory                String?
  quitAttempts                  Int?                      @default(0)
  quitDate                      DateTime?
  createdAt                     DateTime                  @default(now())
  updatedAt                     DateTime                  @updatedAt
  role                          String                    @default("USER")
  isAdmin                       Boolean                   @default(false)
  isProvider                    Boolean                   @default(false)
  isClerk                       Boolean                   @default(false)
  licenseNumber                 String?
  specialty                     String?
  yearsOfExperience             Int?
  availability                  Json?
  isOnline                      Boolean                   @default(false)
  lastSeen                      DateTime?
  providerApprovalStatus        ProviderApprovalStatus?
  googleEmail                   String?
  googleOAuthAccessToken        String?
  googleOAuthExpiry             DateTime?
  googleOAuthRefreshToken       String?
  appointmentsAsPatient         Appointment[]             @relation("PatientAppointments")
  appointmentsAsProvider        Appointment[]             @relation("ProviderAppointments")
  auditLogs                     AuditLog[]                @relation("AuditLogUser")
  conversationsAsPatient        Conversation[]            @relation("ConversationPatient")
  conversationsAsProvider       Conversation[]            @relation("ConversationProvider")
  correspondencesAsPatient      Correspondence[]          @relation("CorrespondencePatient")
  correspondencesSent           Correspondence[]          @relation("CorrespondenceSender")
  correspondencesDispatched     Correspondence[]          @relation("CorrespondenceSentBy")
  patientConnections            DoctorPatientConnection[] @relation("PatientConnections")
  doctorConnections             DoctorPatientConnection[] @relation("DoctorConnections")
  encountersAsPatient           Encounter[]               @relation("EncounterPatient")
  encountersAsProvider          Encounter[]               @relation("EncounterProvider")
  renderingEncounters           Encounter[]               @relation("RenderingProvider")
  healthRecordsAsPatient        HealthRecord[]            @relation("HealthRecordPatient")
  healthRecordsAsProvider       HealthRecord[]            @relation("HealthRecordProvider")
  intakeForms                   IntakeForm[]              @relation("IntakeFormPatient")
  integrationErrorsForPatient   IntegrationError[]        @relation("IntegrationErrorPatient")
  investigationOrdersForPatient InvestigationOrder[]      @relation("InvestigationOrderPatient")
  investigationOrdersByProvider InvestigationOrder[]      @relation("InvestigationOrderProvider")
  investigationResultsReviewed  InvestigationResult[]     @relation("InvestigationResultReviewer")
  patientInvoices               Invoice[]                 @relation("PatientInvoices")
  providerInvoices              Invoice[]                 @relation("ProviderInvoices")
  medicationsAsPatient          Medication[]              @relation("MedicationPatient")
  medicationsPrescribed         Medication[]              @relation("MedicationPrescribedBy")
  sentMessages                  Message[]                 @relation("SentMessages")
  notifications                 Notification[]            @relation("NotificationUser")
  notificationPreference        NotificationPreference?
  prescriptionsAsPatient        Prescription[]            @relation("PrescriptionPatient")
  prescriptionsAsProvider       Prescription[]            @relation("PrescriptionProvider")
  progressNotesAuthored         ProgressNote[]            @relation("ProgressNoteAuthor")
  progressNotesAsPatient        ProgressNote[]            @relation("ProgressNotePatient")
  pushSubscriptions             PushSubscription[]
  smokingMetrics                SmokingMetric[]           @relation("SmokingMetricPatient")
  vitalSigns                    VitalSign[]               @relation("VitalSignPatient")
}

model Appointment {
  id                     String         @id @default(cuid())
  title                  String
  description            String?
  date                   DateTime
  duration               Int            @default(30)
  status                 String         @default("scheduled")
  meetingLink            String?
  notes                  String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  providerId             String
  patientId              String
  price                  Float?
  serviceName            String?
  type                   ServiceType    @default(consultation)
  calendarEventId        String?
  meetingDurationSeconds Int?
  meetingEndAt           DateTime?
  meetingId              String?
  meetingMeta            Json?
  meetingProvider        String?
  meetingStartAt         DateTime?
  patient                User           @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade, map: "Appointment_patientId_fkey")
  provider               User           @relation("ProviderAppointments", fields: [providerId], references: [id], onDelete: Cascade, map: "Appointment_providerId_fkey")
  encounters             Encounter[]    @relation("AppointmentEncounters")
  invoice                Invoice?       @relation("AppointmentInvoice")
  prescriptions          Prescription[] @relation("AppointmentPrescriptions")
}

model HealthRecord {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  date        DateTime
  providerId  String
  patientId   String
  vitalSigns  Json?
  medications String?
  diagnosis   String?
  treatment   String?
  notes       String?
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  patient     User     @relation("HealthRecordPatient", fields: [patientId], references: [id], onDelete: Cascade)
  provider    User     @relation("HealthRecordProvider", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([providerId])
  @@index([date])
}

model VitalSign {
  id               String   @id @default(cuid())
  patientId        String
  recordedAt       DateTime
  bloodPressure    String?
  heartRate        Int?
  oxygenSaturation Int?
  respiratoryRate  Int?
  temperature      Float?
  weight           Float?
  height           Float?
  bmi              Float?
  createdAt        DateTime @default(now())
  patient          User     @relation("VitalSignPatient", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([recordedAt])
}

model SmokingMetric {
  id                  String    @id @default(cuid())
  patientId           String
  recordedAt          DateTime
  cigarettesPerDay    Int?
  carbonMonoxideLevel Int?
  peakFlow            Int?
  cravingsIntensity   Int?
  quitDate            DateTime?
  quitDurationDays    Int?
  createdAt           DateTime  @default(now())
  patient             User      @relation("SmokingMetricPatient", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([recordedAt])
}

model Medication {
  id             String    @id @default(cuid())
  name           String
  dosage         String
  frequency      String
  startDate      DateTime
  endDate        DateTime?
  prescribedById String
  patientId      String
  instructions   String?
  sideEffects    String?
  status         String    @default("active")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  patient        User      @relation("MedicationPatient", fields: [patientId], references: [id], onDelete: Cascade)
  prescribedBy   User      @relation("MedicationPrescribedBy", fields: [prescribedById], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([prescribedById])
  @@index([status])
}

model Prescription {
  id             String             @id @default(cuid())
  patientId      String
  providerId     String
  appointmentId  String?
  medicationName String
  dosage         String
  frequency      String
  duration       String
  quantity       Int
  refills        Int                @default(0)
  instructions   String
  status         PrescriptionStatus @default(DRAFT)
  prescribedDate DateTime           @default(now())
  startDate      DateTime
  endDate        DateTime?
  pharmacy       String?
  pharmacyPhone  String?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  appointment    Appointment?       @relation("AppointmentPrescriptions", fields: [appointmentId], references: [id])
  patient        User               @relation("PrescriptionPatient", fields: [patientId], references: [id], onDelete: Cascade)
  provider       User               @relation("PrescriptionProvider", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([providerId])
  @@index([status])
  @@index([prescribedDate])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  priority  String
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model DoctorPatientConnection {
  id                 String    @id @default(cuid())
  providerId         String
  patientId          String
  treatmentType      String
  status             String    @default("pending")
  requestMessage     String?
  approvedAt         DateTime?
  disconnectedAt     DateTime?
  disconnectReason   String?
  outstandingBalance Float     @default(0)
  canDisconnect      Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  patient            User      @relation("PatientConnections", fields: [patientId], references: [id], onDelete: Cascade)
  provider           User      @relation("DoctorConnections", fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, patientId, treatmentType])
  @@index([providerId])
  @@index([patientId])
  @@index([status])
}

model Invoice {
  id            String       @id @default(cuid())
  invoiceNumber String       @unique
  patientId     String
  providerId    String?
  appointmentId String?      @unique
  description   String
  amount        Float
  status        String       @default("pending")
  dueDate       DateTime?
  paidAt        DateTime?
  paymentMethod String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  currency      String       @default("MYR")
  paymentUrl    String?
  transactionId String?
  appointment   Appointment? @relation("AppointmentInvoice", fields: [appointmentId], references: [id])
  patient       User         @relation("PatientInvoices", fields: [patientId], references: [id], onDelete: Cascade)
  provider      User?        @relation("ProviderInvoices", fields: [providerId], references: [id])

  @@index([patientId])
  @@index([providerId])
  @@index([status])
  @@index([dueDate])
}

model IntakeForm {
  id            String    @id @default(cuid())
  appointmentId String    @unique
  patientId     String
  formData      Json
  currentStep   Int       @default(1)
  completed     Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  patient       User      @relation("IntakeFormPatient", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([completed])
}

model Conversation {
  id         String    @id @default(cuid())
  providerId String
  patientId  String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  patient    User      @relation("ConversationPatient", fields: [patientId], references: [id], onDelete: Cascade)
  provider   User      @relation("ConversationProvider", fields: [providerId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@unique([providerId, patientId])
  @@index([providerId])
  @@index([patientId])
  @@index([updatedAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([read])
}

model Encounter {
  id                  String               @id @default(cuid())
  patientId           String
  providerId          String
  appointmentId       String?
  type                String
  mode                EncounterMode        @default(in_person)
  startTime           DateTime
  endTime             DateTime?
  location            String?
  renderingProviderId String?
  status              EncounterStatus      @default(scheduled)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  correspondences     Correspondence[]
  appointment         Appointment?         @relation("AppointmentEncounters", fields: [appointmentId], references: [id])
  patient             User                 @relation("EncounterPatient", fields: [patientId], references: [id], onDelete: Cascade)
  provider            User                 @relation("EncounterProvider", fields: [providerId], references: [id], onDelete: Cascade)
  renderingProvider   User?                @relation("RenderingProvider", fields: [renderingProviderId], references: [id])
  investigationOrders InvestigationOrder[]
  progressNotes       ProgressNote[]

  @@index([patientId])
  @@index([providerId])
  @@index([appointmentId])
  @@index([startTime])
  @@index([status])
}

model ProgressNote {
  id            String             @id @default(cuid())
  encounterId   String
  patientId     String
  authorId      String
  cosignerIds   String[]           @default([])
  status        ProgressNoteStatus @default(draft)
  subjective    String?
  objective     String?
  assessment    String?
  plan          String?
  summary       String?
  autosavedAt   DateTime?
  finalizedAt   DateTime?
  signatureHash String?
  amendedFromId String?
  attachments   Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  amendedFrom   ProgressNote?      @relation("ProgressNoteAmendment", fields: [amendedFromId], references: [id])
  amendments    ProgressNote[]     @relation("ProgressNoteAmendment")
  author        User               @relation("ProgressNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  encounter     Encounter          @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient       User               @relation("ProgressNotePatient", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([patientId])
  @@index([authorId])
  @@index([status])
  @@index([finalizedAt])
}

model InvestigationOrder {
  id                String                   @id @default(cuid())
  encounterId       String?
  patientId         String
  providerId        String
  code              String?
  name              String
  status            InvestigationOrderStatus @default(ordered)
  orderedAt         DateTime                 @default(now())
  notes             String?
  attachments       Json?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  integrationErrors IntegrationError[]       @relation("IntegrationErrorOrder")
  encounter         Encounter?               @relation(fields: [encounterId], references: [id])
  patient           User                     @relation("InvestigationOrderPatient", fields: [patientId], references: [id], onDelete: Cascade)
  provider          User                     @relation("InvestigationOrderProvider", fields: [providerId], references: [id], onDelete: Cascade)
  results           InvestigationResult[]

  @@index([patientId])
  @@index([providerId])
  @@index([encounterId])
  @@index([status])
  @@index([orderedAt])
}

model InvestigationResult {
  id                 String                     @id @default(cuid())
  orderId            String
  code               String?
  name               String?
  value              String?
  units              String?
  referenceRangeLow  Float?
  referenceRangeHigh Float?
  referenceRangeText String?
  interpretation     ObservationInterpretation?
  performer          String?
  observedAt         DateTime?
  fhirObservation    Json?
  reviewed           Boolean                    @default(false)
  reviewerId         String?
  reviewedAt         DateTime?
  attachments        Json?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  order              InvestigationOrder         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewer           User?                      @relation("InvestigationResultReviewer", fields: [reviewerId], references: [id])

  @@index([orderId])
  @@index([observedAt])
  @@index([interpretation])
  @@index([reviewed])
}

model Correspondence {
  id                  String                  @id @default(cuid())
  encounterId         String?
  patientId           String
  senderId            String?
  recipients          Json
  subject             String
  body                String
  mergeFields         Json?
  attachments         Json?
  direction           CorrespondenceDirection
  category            CorrespondenceCategory
  transmissionChannel TransmissionChannel?
  sentById            String?
  sentAt              DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  encounter           Encounter?              @relation(fields: [encounterId], references: [id])
  patient             User                    @relation("CorrespondencePatient", fields: [patientId], references: [id], onDelete: Cascade)
  sender              User?                   @relation("CorrespondenceSender", fields: [senderId], references: [id])
  sentBy              User?                   @relation("CorrespondenceSentBy", fields: [sentById], references: [id])

  @@index([patientId])
  @@index([encounterId])
  @@index([direction])
  @@index([category])
  @@index([sentAt])
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  entityType EntityType
  entityId   String
  ip         String?
  source     AuditSource @default(api)
  timestamp  DateTime    @default(now())
  metadata   Json?
  user       User?       @relation("AuditLogUser", fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([action])
  @@index([timestamp])
}

model Template {
  id          String                  @id @default(cuid())
  name        String                  @unique
  subject     String?
  category    CorrespondenceCategory?
  htmlContent String
  fields      Json?
  active      Boolean                 @default(true)
  isDefault   Boolean                 @default(false)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
}

model IntegrationError {
  id           String              @id @default(cuid())
  patientId    String
  orderId      String?
  entityType   String
  source       String?
  payload      Json
  errorMessage String
  retryCount   Int                 @default(0)
  nextRetryAt  DateTime?
  lastTriedAt  DateTime?
  status       IngestionStatus     @default(pending)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  order        InvestigationOrder? @relation("IntegrationErrorOrder", fields: [orderId], references: [id])
  patient      User                @relation("IntegrationErrorPatient", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([orderId])
  @@index([status])
  @@index([nextRetryAt])
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  deviceType String
  deviceName String?
  browser    String?
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model NotificationPreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  appointments   Boolean  @default(true)
  messages       Boolean  @default(true)
  prescriptions  Boolean  @default(true)
  investigations Boolean  @default(true)
  marketing      Boolean  @default(false)
  emailEnabled   Boolean  @default(true)
  pushEnabled    Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ServiceType {
  consultation
  follow_up
  emergency
  quitline_smoking_cessation
  psychiatrist_session
}

enum ProviderApprovalStatus {
  pending
  approved
  rejected
}

enum PrescriptionStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum EncounterMode {
  in_person
  telemedicine
  phone
  messaging
}

enum EncounterStatus {
  scheduled
  in_progress
  completed
  cancelled
}

enum ProgressNoteStatus {
  draft
  finalized
  amended
}

enum InvestigationOrderStatus {
  ordered
  cancelled
  completed
}

enum ObservationInterpretation {
  normal
  abnormal
  critical
}

enum CorrespondenceDirection {
  inbound
  outbound
}

enum CorrespondenceCategory {
  referral
  reply
  discharge
  memo
}

enum TransmissionChannel {
  email
  fax
  portal
  print
  other
}

enum AuditAction {
  create
  read
  update
  delete
  view
  finalize
  amend
  review
  send
}

enum AuditSource {
  api
  system
  integration
}

enum EntityType {
  encounter
  progress_note
  investigation_order
  investigation_result
  correspondence
  template
  user
  appointment
}

enum IngestionStatus {
  pending
  retrying
  failed
  resolved
}
